{% extends "converter/base.html" %}

{% block title %}文本转换器主页{% endblock %}

{% block extra_head %}
<style>
    /* Styles specific to index.html - main converter layout */
    .container { background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin: 20px; }
    /* Remove h1 styling from here as it's in base or not needed */
    /* .header-nav-container no longer needed as header is in base.html */
    /* .tabs and .tabs button styling might need to be adjusted if they are inside .content now */
    .main-tabs-container { display: flex; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #ddd; padding-bottom: 10px; }
    .main-tabs-container h1.page-title { color: #333; margin: 0; font-size: 24px; }
    .tabs { display: flex; margin-left: 30px; }
    .tabs button { background-color: #eee; border: 1px solid #eee; padding: 10px 20px; cursor: pointer; font-size: 16px; margin-left: 5px; border-radius: 5px 5px 0 0; transition: background-color 0.3s, color 0.3s, border-color 0.3s; }
    .tabs button.active { 
        background-color: #e7f3ff; 
        color: #007bff; 
        border: 1px solid #007bff; 
        border-bottom: 1px solid #e7f3ff; 
        font-weight: bold; 
    }
    .tabs button:hover { background-color: #ccc; }
    /* User actions styling is in base.html */

    .sub-tabs { display: flex; justify-content: flex-start; margin-bottom: 20px; padding-left: 10px;}
    .sub-tabs button { background-color: #f9f9f9; border: 1px solid #ddd; padding: 8px 15px; cursor: pointer; font-size: 14px; margin-right: 5px; border-radius: 4px; transition: background-color 0.3s, border-color 0.3s; }
    .sub-tabs button.active { background-color: #007bff; color: white; border-color: #007bff; }
    .sub-tabs button:hover { background-color: #e9e9e9; }
    .content-area { border: 2px dashed #ccc; padding: 40px; text-align: center; border-radius: 8px; background-color: #fafafa; margin-bottom: 20px; }
    .content-area p { margin: 0; font-size: 18px; color: #666; }
    .action-buttons { display: flex; justify-content: space-between; align-items: center; margin-top: 20px;}
    .action-buttons .left-buttons button { background-color: #6c757d; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; margin-right: 10px;}
    .action-buttons .left-buttons button:hover { background-color: #5a6268; }
    .action-buttons .right-buttons button { background-color: #007bff; color: white; padding: 12px 25px; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; font-weight: bold; }
    .action-buttons .right-buttons button:hover { background-color: #0056b3; }
    .hidden { display: none; }

    .converted-files-container { margin-top: 30px; }
    .converted-files-container h3 { margin-bottom: 10px; color: #333; font-size: 18px; }
    #convertedFileList { list-style-type: none; padding-left: 0; }
    #convertedFileList li { background-color: #f9f9f9; border: 1px solid #eee; padding: 10px; margin-bottom: 5px; border-radius: 4px; display: flex; justify-content: space-between; align-items: center; }
    #convertedFileList li .file-name { color: #333; }
    #convertedFileList li .download-link { color: #007bff; text-decoration: none; font-weight: bold; }
    #convertedFileList li .download-link:hover { text-decoration: underline; }
</style>
{% endblock %}

{% block content %}
<div class="container">
    {# The header with title and main user actions is now in base.html #}
    {# This container is for the main content of the converter page #}
    <div class="main-tabs-container">
        <h1 class="page-title">文本转换器</h1> {# Kept H1 here as it's specific to this page's main function #}
        <div class="tabs">
            <button id="btnImgToFile" class="tab-button active" onclick="showTab('imgToFile')">图片转文件</button>
            <button id="btnFileToPdf" class="tab-button" onclick="showTab('fileToPdf')">文件转PDF</button>
            <button id="btnPdfToFile" class="tab-button" onclick="showTab('pdfToFile')">PDF转文件</button>
        </div>
        {# user-actions div removed from here, it is in base.html #}
    </div>

    <div id="imgToFileContent" class="tab-content">
        <div class="sub-tabs">
            <button class="sub-tab-button active" onclick="selectSubTab(this, 'imgToWord')">图片转Word</button>
            <button class="sub-tab-button" onclick="selectSubTab(this, 'imgToPdf')">图片转PDF</button>
        </div>
    </div>

    <div id="fileToPdfContent" class="tab-content hidden">
        <div class "sub-tabs">
            <button class="sub-tab-button active" onclick="selectSubTab(this, 'wordToPdf')">Word转PDF</button>
            <button class="sub-tab-button" onclick="selectSubTab(this, 'excelToPdf')">Excel转PDF</button>
            <button class="sub-tab-button" onclick="selectSubTab(this, 'pptToPdf')">PPT转PDF</button>
            <button class="sub-tab-button" onclick="selectSubTab(this, 'txtToPdf')">TXT转PDF</button>
        </div>
    </div>

    <div id="pdfToFileContent" class="tab-content hidden">
        <div class="sub-tabs">
            <button class="sub-tab-button active" onclick="selectSubTab(this, 'pdfToWord')">PDF转Word</button>
            <button class="sub-tab-button" onclick="selectSubTab(this, 'pdfToExcel')">PDF转Excel</button>
            <button class="sub-tab-button" onclick="selectSubTab(this, 'pdfToPpt')">PDF转PPT</button>
            <button class="sub-tab-button" onclick="selectSubTab(this, 'pdfToTxt')">PDF转TXT</button>
        </div>
    </div>

    <div class="content-area">
        <p>点击添加文件 或 拖拽至此区域</p>
        <input type="file" id="fileUpload" multiple style="display: none;" onchange="handleFiles(this.files)">
        {% csrf_token %} {# Add CSRF token for AJAX POST requests if not already in a form that includes it #}
    </div>
    
    <ul id="fileList"></ul>

    <div class="action-buttons">
        <div class="left-buttons" style="display: flex; flex-direction: column; align-items: flex-start;">
            <div style="display: flex; align-items: center;">
                <button onclick="document.getElementById('fileUpload').click();">+ 添加文件</button>
                <button onclick="clearFileList()" style="margin-left: 10px;">清空列表</button>
                <label style="margin-left: 15px; display: flex; align-items: center; font-size: 0.9em; font-weight: normal; cursor:pointer;">
                    <input type="checkbox" id="mergeOutputCheckbox" checked style="margin-right: 5px; cursor:pointer;">
                    合并为一个文件
                </label>
            </div>
            <div id="fileUploadTips" style="font-size: 0.8em; color: #666; margin-top: 8px;">
                提示：最多选择10个文件，单个文件不超过10MB。
            </div>
        </div>
        
        <div class="right-buttons">
            <button id="startConversionBtn" onclick="startConversion()">开始转换</button>
        </div>
    </div>

    <div class="converted-files-container">
        <h3>转换文件列表</h3>
        <div id="convertedFilesTableContainer">
            <!-- Table will be inserted here by JavaScript -->
        </div>
    </div>
</div>

<script>
    // Script remains largely the same, specific to index.html functionality
    let currentSelectedSubTab = null; 
    let isConverting = false; // Flag to prevent multiple simultaneous conversions

    function showTab(tabId) {
        document.querySelectorAll('.tab-content').forEach(tab => tab.classList.add('hidden'));
        document.getElementById(tabId + 'Content').classList.remove('hidden');

        document.querySelectorAll('.tab-button').forEach(button => button.classList.remove('active'));
        document.getElementById('btn' + tabId.charAt(0).toUpperCase() + tabId.slice(1)).classList.add('active');
        
        const firstSubTabButton = document.getElementById(tabId + 'Content').querySelector('.sub-tab-button');
        if (firstSubTabButton) {
            selectSubTab(firstSubTabButton, firstSubTabButton.getAttribute('onclick').match(/'(.*?)'/)[1].split(',')[1].replace(/['\)]/g, '').trim());
        }
    }

    function selectSubTab(buttonElement, subTabType) {
        buttonElement.parentElement.querySelectorAll('.sub-tab-button').forEach(btn => btn.classList.remove('active'));
        buttonElement.classList.add('active');
        currentSelectedSubTab = subTabType;
        console.log("当前选择的转换类型: ", currentSelectedSubTab);
        updateFileUploadTips(currentSelectedSubTab);
    }

    function updateFileUploadTips(subTabType) {
        const tipsEl = document.getElementById('fileUploadTips');
        // Example: Customize tips for specific conversion types if necessary
        // if (subTabType === 'imgToWord') {
        //     tipsEl.textContent = "提示：图片转Word。最多10个文件，单个不超过10MB。";
        // } else {
        //     tipsEl.textContent = "提示：最多选择10个文件，单个文件不超过10MB。";
        // }
        // For now, the generic tip is fine.
    }

    function handleFiles(incomingFiles) {
        const fileList = document.getElementById('fileList');
        const existingFileCount = fileList.getElementsByTagName('li').length;
        const maxFiles = 10;
        const maxFileSize = 10 * 1024 * 1024; // 10MB

        let addedCount = 0;
        for (const file of incomingFiles) {
            if (existingFileCount + addedCount >= maxFiles) {
                alert(`最多只能添加 ${maxFiles} 个文件。`);
                break;
            }
            if (file.size > maxFileSize) {
                alert(`单个文件 "${file.name}" 大小不能超过10MB。`);
                continue; // Skip this file
            }

            const listItem = document.createElement('li');
            listItem.textContent = file.name + ' (' + (file.size / 1024 / 1024).toFixed(2) + ' MB)'; // Show size in MB
            listItem.setAttribute('data-filename', file.name); // Store filename for potential removal later
            fileList.appendChild(listItem);
            addedCount++;
        }
        
        // Update the actual file input's files property to only include successfully validated files.
        // This is tricky because FileList is immutable. A common workaround is to re-assign 'value' to null 
        // if any files are rejected, forcing the user to re-select valid files, 
        // or to manage the files to be uploaded in a separate array.
        // For simplicity here, if any file is rejected, we clear the input. The user should be notified.
        if (incomingFiles.length > 0 && addedCount < incomingFiles.length) {
            // Some files were rejected
            document.getElementById('fileUpload').value = null; // Clear the input
             // Re-filter the fileList UI to show only the valid ones that would have been processed
            const currentFiles = Array.from(document.getElementById('fileUpload').files); // This will be empty now
            const newUiFiles = [];
            const listItems = fileList.getElementsByTagName('li');
            // This logic gets complex if we want to perfectly sync a separate array with the UI
            // and the file input.
            // The simplest at this stage is to manage files in an array if we need to filter the input.
            // For now, we will just alert and the user might have to re-select.
            // A better UX would be to maintain a global array `filesToUpload`
        }
        
        // If we are managing a separate array for files to upload:
        // globalFilesToUpload.push(...validFiles);
        // Then use globalFilesToUpload in startConversion
    }

    function clearFileList() {
        document.getElementById('fileList').innerHTML = '';
        document.getElementById('fileUpload').value = null; 
        document.getElementById('convertedFilesTableContainer').innerHTML = ''; // Also clear converted files table
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    function startConversion() {
        if (isConverting) {
            alert("已有转换任务正在进行中，请稍候。");
            return;
        }

        const fileInput = document.getElementById('fileUpload');
        const files = fileInput.files; // These are the files currently selected in the input
        
        // It's better to use a list of files accumulated from handleFiles if complex validation/filtering happens.
        // For now, assuming handleFiles has done basic checks and the files in fileInput are what we attempt.
        const fileListUI = document.getElementById('fileList').getElementsByTagName('li');

        if (fileListUI.length === 0) { // Check our visual list instead of fileInput.files directly
            alert("请先添加文件！");
            return;
        }
        
        // Re-validate before sending, in case the input was manipulated or to be absolutely sure.
        const maxFiles = 10;
        const maxFileSize = 10 * 1024 * 1024; // 10MB

        if (fileListUI.length > maxFiles) {
            alert(`最多只能转换 ${maxFiles} 个文件。请先清空列表并重新选择。`);
            return;
        }

        const filesToUpload = [];
        // We need to get the actual File objects. The fileListUI only has text.
        // This means we MUST rely on the fileInput.files, or manage File objects in a global array.
        // Let's assume fileInput.files is the source of truth after selection.
        // The handleFiles function should ensure fileInput.files reflects valid choices,
        // or we build a separate array.

        // Given the previous handleFiles logic might clear fileInput.value,
        // it's more robust to build an array of File objects.
        // Let's modify handleFiles to populate such an array.

        // For now, proceeding with fileInput.files, assuming it's not cleared by handleFiles
        // unless ALL files are bad. If handleFiles clears it on ANY bad file, then this files array will be empty.

        if (files.length === 0 && fileListUI.length > 0) {
             alert("文件选择似乎有问题，请重新选择文件。");
             // This state can happen if handleFiles clears the input after some invalid files were chosen
             // but leaves the UI list populated.
             return;
        }
        if (files.length === 0 && fileListUI.length === 0){
            alert("请先添加文件！");
            return;
        }

        isConverting = true;
        const startBtn = document.getElementById('startConversionBtn');
        startBtn.textContent = "等待转换中...";
        startBtn.style.backgroundColor = "yellow";
        startBtn.style.color = "black";
        startBtn.disabled = true;

        const formData = new FormData();
        for (let i = 0; i < files.length; i++) {
            if (files[i].size > maxFileSize) {
                alert(`文件 "${files[i].name}" 超过10MB，将不会被处理。`);
                continue; // Skip this file
            }
            if (i >= maxFiles) { // Should be filesToUpload.length if using a separate array
                 alert(`超过最大文件数 ${maxFiles}，部分文件将不会被处理。`);
                 break;
            }
            formData.append('images', files[i]);
        }

        if (!formData.has('images')) {
            alert("没有有效的文件可供转换。请检查文件大小和数量限制。");
            isConverting = false;
            startBtn.textContent = "开始转换";
            startBtn.style.backgroundColor = "#007bff";
            startBtn.style.color = "white";
            startBtn.disabled = false;
            return;
        }

        const mergeOutput = document.getElementById('mergeOutputCheckbox').checked;
        formData.append('merge_output', mergeOutput);
        // formData.append('conversion_type', currentSelectedSubTab); // If needed later

        fetch("{% url 'converter:process_image_to_word' %}", { // Ensure this URL is correct
            method: 'POST',
            headers: {
                'X-CSRFToken': csrftoken
            },
            body: formData
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log("Conversion response:", data);
            isConverting = false;
            startBtn.textContent = "开始转换";
            startBtn.style.backgroundColor = "#007bff";
            startBtn.style.color = "white";
            startBtn.disabled = false;

            if (data.results) {
                displayConvertedFilesTable(data.results);
                console.log("转换处理完成，结果已显示。");
            } else {
                alert("转换失败或未返回结果。");
                displayConvertedFilesTable([]); // Clear or show empty table
            }
        })
        .catch(error => {
            console.error("Conversion error:", error);
            isConverting = false;
            startBtn.textContent = "开始转换";
            startBtn.style.backgroundColor = "#007bff";
            startBtn.style.color = "white";
            startBtn.disabled = false;
            alert("转换过程中发生错误: " + error.message);
            displayConvertedFilesTable([]); // Clear or show empty table
        });
    }

    function displayConvertedFilesTable(results) { // results is now an array from backend
        const tableContainer = document.getElementById('convertedFilesTableContainer');
        tableContainer.innerHTML = ''; // Clear previous table/content

        if (!results || results.length === 0) {
            // Optionally display a message if no files were converted or an error occurred
            const p = document.createElement('p');
            p.textContent = '没有转换结果可显示。';
            tableContainer.appendChild(p);
            return;
        }

        const table = document.createElement('table');
        table.style.width = '100%';
        table.style.borderCollapse = 'collapse';
        table.style.marginTop = '10px';

        // Table Header
        const thead = table.createTHead();
        const headerRow = thead.insertRow();
        const th1 = document.createElement('th');
        th1.textContent = '文件名';
        th1.style.border = '1px solid #ddd';
        th1.style.padding = '8px';
        th1.style.textAlign = 'left';
        th1.style.backgroundColor = '#f2f2f2';
        headerRow.appendChild(th1);

        const th2 = document.createElement('th');
        th2.textContent = '操作';
        th2.style.border = '1px solid #ddd';
        th2.style.padding = '8px';
        th2.style.textAlign = 'center'; // Center download button
        th2.style.width = '120px'; // Fixed width for action column
        th2.style.backgroundColor = '#f2f2f2';
        headerRow.appendChild(th2);

        // Table Body
        const tbody = table.createTBody();
        results.forEach(result => {
            const row = tbody.insertRow();
            
            const cell1 = row.insertCell();
            cell1.textContent = result.converted_name || result.original_name; // Show converted name or original if error
            cell1.style.border = '1px solid #ddd';
            cell1.style.padding = '8px';

            const cell2 = row.insertCell();
            if (result.status === 'success' && result.download_url) {
                const downloadLink = document.createElement('a');
                downloadLink.href = result.download_url;
                downloadLink.textContent = '下载';
                downloadLink.setAttribute('download', result.converted_name || 'converted_file.docx'); // Suggest a filename to the browser
                downloadLink.style.padding = '5px 10px';
                downloadLink.style.backgroundColor = '#28a745';
                downloadLink.style.color = 'white';
                downloadLink.style.textDecoration = 'none';
                downloadLink.style.border = 'none';
                downloadLink.style.borderRadius = '4px';
                downloadLink.style.cursor = 'pointer';
                cell2.appendChild(downloadLink);
            } else {
                cell2.textContent = result.message || '转换失败';
                cell2.style.color = 'red';
            }
            cell2.style.border = '1px solid #ddd';
            cell2.style.padding = '8px';
            cell2.style.textAlign = 'center';
        });
        tableContainer.appendChild(table);
    }

    document.addEventListener('DOMContentLoaded', function() {
        showTab('imgToFile');
    });
</script>
{% endblock %} 