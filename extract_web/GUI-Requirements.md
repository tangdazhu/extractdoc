# GUI 需求文档：文本转换器 Web 应用

## 一、 整体页面布局与风格

应用主标题为"文本转换器"。页面设计应简洁、现代，注重用户体验。

### 1.1 主导航区

位于"文本转换器"标题的右侧，包含以下第一级标签页切换按钮：

-   图片转文件
-   文件转PDF (规划中，未实现)
-   PDF转文件 (规划中，未实现)

### 1.2 子导航区与内容区

根据所选的第一级标签页，动态显示对应的第二级功能按钮。选中某个第一级标签页时，其文字应变为蓝色，卡片背景（或边框）也应突出显示（例如，加上蓝色边框和浅蓝色背景）。

-   **当选中"图片转文件"时，下方显示的子功能按钮为：**
    -   图片转Word
    -   图片转PDF
-   **当选中"文件转PDF"时 (规划中)：**
    -   Word转PDF
    -   Excel转PDF
    -   PPT转PDF
    -   TXT转PDF
-   **当选中"PDF转文件"时 (规划中)：**
    -   PDF转Word
    -   PDF转Excel
    -   PDF转PPT
    -   PDF转TXT

### 1.3 文件操作区

所有转换功能共用以下操作按钮和区域：

-   **文件上传区域**：清晰指示用户点击或拖拽文件进行添加。
-   **操作按钮**：
    -   `+ 添加文件`
    -   `清空列表`
    -   `合并为一个文件` (复选框，默认选中)
    -   `开始转换`（核心功能按钮，应醒目）

### 1.4 转换结果区 (主转换页面实时列表)

位于"开始转换"按钮下方，用于展示当前批次转换完成后生成的文件列表。

-   标题："转换文件列表"
-   列表项（表格形式）：
    -   原始文件名：显示用户上传时的原始文件名。如果是多个文件合并，则显示逗号分隔的原始文件名列表 (例如：`1.jpg,2.jpg`)。
    -   转换后文件名：显示服务器生成的最终文件名。
    -   操作：提供"下载"链接。
    -   状态：显示转换状态 (例如：`success`, `conversion_error`)。

### 1.5 用户状态区 (导航栏)

位于页面右上角，根据用户登录状态显示不同链接：

-   **未登录时：**
    -   `注册`
    -   `登录`
-   **普通用户登录后：**
    -   `历史转换记录`
    -   `登出 (用户名)`
-   **管理员用户（例如 admin）登录后：**
    -   `管理控制台`
    -   `历史转换记录`
    -   `登出 (用户名)`

## 二、 用户注册与登录功能

### 2.1 注册功能

-   **触发**：点击导航区的"注册"按钮。
-   **表单字段**：
    -   用户名：英文字母和数字组合，不超过10位。
    -   密码：英文字母和数字组合，不超过10位。
    -   确认密码。
-   所有提示文字、标签、错误信息等均为中文。
-   用户注册成功后自动登录，并创建用户专属的顶层数据目录：
    -   在 `extract_doc/extract_web/his_pic/` 目录下创建以该用户名命名的文件夹 (例如 `extract_doc/extract_web/his_pic/testuser/`)。
    -   日期相关的子目录 (如 `YYYYMMDD`) 将在用户首次进行文件转换操作时，在上述用户目录下按需创建。

### 2.2 登录功能

-   **触发**：点击导航区的"登录"按钮。
-   **表单字段**：用户名、密码。
-   **默认管理员账户**：
    -   用户名：`admin`
    -   密码：`admin` (通过自定义管理命令 `set_admin_password` 设置)

## 三、特定用户功能

### 3.1 管理员（admin）功能 - 管理控制台

-   **入口**：管理员登录后，导航区出现"管理控制台"链接，点击进入。
-   **布局**：左右分栏页面，左侧为导航菜单，右侧为内容显示区。
-   **左侧边栏（导航菜单）**：
    1.  **用户管理**：
        -   功能：展示所有注册用户列表，提供编辑和删除操作。
        -   **用户列表显示**：用户名、邮箱、是否为员工、是否激活、是否为超级用户。
        -   **编辑用户**：点击某用户旁的"编辑"链接，进入该用户的编辑页面。
            -   可修改字段：用户名、邮箱、是否为员工 (Is staff)、是否激活 (Is active)。
            -   提供独立的"重置密码"表单，用于修改该用户密码。
            -   所有字段和提示信息均为中文。
        -   **删除用户**：点击某用户旁的"删除"链接 (POST请求，有JS确认弹窗)。
            -   物理删除用户记录。
            -   同时删除该用户在 `extract_doc/extract_web/his_pic/` 下的整个数据文件夹 (例如 `extract_doc/extract_web/his_pic/deleteduser/`)。
            -   不能删除当前登录的管理员自己或其他超级管理员。
        -   **添加新用户**：通过页面上的"注册"链接跳转到标准的注册页面。
    2.  **文件管理 (规划中)**：
        -   功能：管理项目各用户生成的转换文件，提供查看和删除功能。

### 3.2 普通用户（及管理员）功能 - 历史转换记录页面

-   **入口**：用户登录后，导航区出现"历史转换记录"链接，点击进入。
-   **页面顶部**：提供一个 "&laquo; 返回主页" 的链接。
-   **布局**：左右分栏页面。
    -   **左侧边栏（日期导航区）**：
        -   以 `YYYYMMDD` 格式的日期（例如 `20230522`）组织用户的历史转换记录。日期按倒序排列（最新的在前）。
        -   列表顶部有一个"选择日期查看记录"的链接，点击后右侧不显示特定日期的文件，提示用户选择日期。
        -   点击某个日期链接后，该日期在列表中高亮显示，右侧加载对应日期的转换文件。
    -   **右侧主内容区（转换文件列表区）**：
        -   若未选择日期或选择的日期下无文件，则显示相应提示信息 (例如 "请从左侧选择一个日期以查看转换文件。" 或 "选定日期内没有转换文件。")。
        -   若选定日期下有文件，则以表格形式显示该日期的转换文件列表。
        -   表格标题固定为 "转换文件"。
        -   **列表列定义**：
            1.  **原始文件名**：显示用户上传时的原始文件名。
                -   通过读取与转换后文件同名、但后缀为 `.meta` 的元数据文件获取。
                -   如果是多个文件合并转换的结果，则显示逗号分隔的原始文件名列表 (例如：`1.jpg,2.jpg`)。
                -   如果 `.meta` 文件不存在（例如旧的转换记录），则显示转换后文件名去除扩展名和特定后缀（如 `_tempScriptOutput`）后的部分作为后备。
            2.  **转换后文件名**：显示服务器上存储的最终文件名 (例如 `tang1_20230522_abcdefgh.pdf`)。
            3.  **状态**：固定显示 "已完成" (或成功转换的标识)。
            4.  **操作**：
                -   **下载**：蓝色文本链接，点击后在新标签页下载对应的转换后文件。
                -   **删除**：红色文本链接，点击后弹出确认对话框。确认后，物理删除服务器上的转换后文件及其对应的 `.meta` 元数据文件。如果删除文件后 `converted_files` 目录变空，则尝试删除该目录；如果 `converted_files` 目录删除后，其父级日期目录 (例如 `YYYYMMDD`) 也变空（即其下的 `uploads` 目录也不存在或为空），则尝试删除该日期目录。

## 四、核心转换流程：图片转文件 (Word/PDF)

### 4.1 用户界面交互

1.  用户在"图片转文件"主标签页下，选择"图片转Word"或"图片转PDF"子标签页，以确定最终输出格式。
2.  用户通过文件上传区域添加一个或多个图片文件。
    -   前端限制：最多选择10个文件，单个文件大小不超过10MB。相关提示显示在"+ 添加文件"按钮下方。
    -   已选文件列表会显示在上传区域下方。
3.  用户可勾选或取消"合并为一个文件"复选框（默认选中）。
4.  点击"开始转换"按钮：
    -   按钮文字变为"等待转换中..."，背景色变为黄色（或有其他视觉反馈）。
    -   向后端发起处理请求，包含图片文件、合并选项 (`merge_output`) 和输出格式 (`output_format`：`docx` 或 `pdf`)。
5.  转换完成后：
    -   "等待转换中..."按钮恢复为"开始转换"。
    -   下方的"转换文件列表"表格更新，显示本次转换的结果（原始文件名、转换后文件名、下载链接、状态）。

### 4.2 后端处理逻辑 (`process_images_view`)

1.  接收前端传来的图片文件、`merge_output` 和 `output_format` 参数。
2.  为当前用户和当前日期（`YYYYMMDD`）创建或确认目标存储路径：
    -   上传路径: `extract_doc/extract_web/his_pic/<username>/<YYYYMMDD>/uploads/`
    -   转换后文件路径: `extract_doc/extract_web/his_pic/<username>/<YYYYMMDD>/converted_files/`
3.  保存上传的图片到 `uploads` 目录。
4.  **核心处理（两阶段）**：
    -   **阶段一 (脚本调用)**：对于每个上传的图片，总是调用外部Python脚本 (`extract_text_from_images.py`)，指示其输出一个临时的 `.docx` 文件到用户的当日 `converted_files` 目录中。这些临时文件命名可能包含 `_tempScriptOutput` 后缀。
    -   **阶段二 (视图内合并/转换)**：
        -   **若 `merge_output` 为真**：
            -   使用 `python-docx` 库将阶段一生成的所有临时 `.docx` 文件合并为一个主 `.docx` 文件。合并后的文件名格式为 `<username>_<YYYYMMDD>_<8位随机字符>.docx`。
            -   **如果目标 `output_format` 是 `pdf`**：尝试使用 `docx2pdf` 库将合并后的主 `.docx` 文件转换为 `.pdf` 文件。成功则删除主 `.docx`；失败则保留主 `.docx`，并向用户发送提示。
            -   删除阶段一生成的各个临时 `.docx` 文件。
            -   为最终的合并文件（`.docx` 或 `.pdf`）创建一个 `.meta` 文件，存储所有原始上传文件的名称列表（逗号分隔）。
            -   准备JSON响应，`original_name` 字段包含逗号分隔的原始文件名。
        -   **若 `merge_output` 为假**：
            -   遍历阶段一生成的每个临时 `.docx` 文件：
                -   **如果目标 `output_format` 是 `pdf`**：尝试将其转换为 `.pdf`。成功则删除临时 `.docx`；失败则保留临时 `.docx`。
                -   **如果目标 `output_format` 是 `docx`**：将临时 `.docx` 文件重命名（或保持原样，如果已符合最终命名规则）。
                -   为每个最终生成的单文件（`.docx` 或 `.pdf`）创建一个 `.meta` 文件，存储其对应的原始上传文件名。
                -   准备JSON响应，`original_name` 字段包含该文件对应的原始上传文件名。
5.  返回包含所有已处理文件信息（原始文件名、转换后文件名、下载URL、状态）的JSON响应给前端。

### 4.3 外部脚本 (`extract_text_from_images.py`)

-   接受输入图片路径、输出文件路径和 `--format` (值为 `docx` 或 `pdf`) 参数。
-   使用 PaddleOCR 等库提取图片中的文本和表格。
-   将提取内容保存到指定输出路径。
-   如果 `--format` 为 `pdf`，脚本会先生成 `.docx`，然后尝试调用 `docx2pdf` 将其转换为 `.pdf`，成功后删除中间的 `.docx` 文件。若 `docx2pdf` 转换失败或库不可用，则只保留 `.docx` 文件。
